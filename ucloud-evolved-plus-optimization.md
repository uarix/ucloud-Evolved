# UCloud-Evolved-Plus 脚本全面优化需求

## 1. 背景与目标
- 当前脚本为 Tampermonkey 用户脚本 v0.82，单文件约 6.7k 行，覆盖首页、课程、作业、资源预览、下载等多种功能。
- 功能增长带来了体量膨胀、逻辑交叉、代码重复以及难以验证的问题，影响后续维护与扩展效率。
- 本文旨在梳理现状、评估问题，并给出可以指导一次系统性优化/重构的需求清单和验收标准。

## 2. 现状概览
- 入口在自执行函数内，通过拦截 XHR/fetch、重写 history、MutationObserver 等手段改造 ucloud 平台页面。
- `Utils`、`Storage`、`Settings`、`Cache`、`API`、`DownloadManager`、`NotificationManager`、`CourseExtractor`、`UCloudEnhancer` 等类集中在同一文件内，职责边界模糊。
- 大量 `GM_addStyle` 注入的 CSS、HTML 模板与逻辑代码混杂，样式与组件缺乏统一抽象。
- GM_* API 的使用与原生 fetch/XHR 混合，存在重复的容错和鉴权处理逻辑。

## 3. 问题评估

### 3.1 架构与可维护性
- 单文件体量过大，多数类仅通过注释分段，缺乏模块化与构建流程，难以复用或单独测试。
- 业务逻辑与视图操作紧耦合（例如课程抽取、作业面板、下载处理混在 `UCloudEnhancer` 内), 新功能只能继续追加条件分支。
- 工具类 `Utils` 过于庞大，既包含 DOM 工具也包含网络、校验、文件名处理等，难以掌控依赖关系。

### 3.2 状态与数据管理
- 设置项散落在多个类别中，`GM_getValue` 与内存副本并存，没有统一的 schema、版本迁移或校验。
- `Storage` 与 `API` 同时维护课程信息缓存，缺少集中失效策略，可能出现逻辑偏差。
- DEBUG/日志开关没有与设置联动，也缺少远程诊断渠道。

### 3.3 DOM 与交互实现
- 多处使用硬编码选择器与 `innerHTML` 模板构建复杂结构，缺乏组件化，页面结构调整时维护成本高。
- `GM_addStyle` 注入的样式碎片化，存在主题、通知、下载、预览等多段重复或冲突风险。
- MutationObserver 与事件监听器零散创建，生命周期由 `destroy()` 手动管理，容易遗漏或重复绑定。

### 3.4 性能与资源消耗
- 课程抽取、通知排序、批量下载等功能在 SPA 路由切换时反复初始化，缺少缓存的冷启动优化与并发控制。
- `Utils.wait` 广泛依赖 MutationObserver 轮询查找元素，缺少对失败/超时的显式提示。
- 批量操作（如批量下载）未限制并发，容易触发浏览器/服务器限制。

### 3.5 下载与预览流程
- `DownloadManager` 使用单一实例字段 (`this.downloading`、`this.controller`) 追踪状态，难以同时支持多文件任务或队列。
- `fetchBinary`、`downloadFile`、`downloadViaGM` 三套逻辑存在重复，错误处理不一致，GM/fetch 切换逻辑复杂。
- 预览重定向（Office/PDF/图片）部分依赖阻断 `window.stop()`，缺乏失败时的用户指示与回退方案。

### 3.6 稳定性与观测
- API 调用缺少统一的错误分级与重试策略，异常仅写控制台或 toast，无法统计。
- 通知、作业等特性依赖 DOM 数据结构，缺少断言/校验，平台 UI 更新时难以及时发现。
- 缺少自动化测试与发布检测，版本回归风险高。

### 3.7 工程化与协作
- 无构建脚本、包管理、代码风格校验、版本分支策略，难以形成协作流程。
- 资源校验（如 JSZip hash）写死在代码中，缺少更新机制。
- 缺少开发文档、贡献指南和变更日志，外部贡献者难以介入。

## 4. 优化需求

### 4.1 架构与代码组织
- [x][R1] 建立基于 TypeScript/ESM 的模块化工程，通过 Rollup/Vite 等工具构建单一用户脚本输出，拆分核心逻辑、服务层、视图层。
- [x][R2] 重构 `Utils` 为多文件工具集（DOM、网络、格式化、文件系统等），并明确依赖方向，避免工具反向引用业务模块。
- [x][R3] 将拦截器、主题/样式、页面适配器、下载服务等独立为可组合的子模块，主入口仅负责路由分发和生命周期管理。

### 4.2 状态、缓存与配置
- [R4] 设计设置项 schema（含默认值、版本号、可见性、实验性标记），提供升级迁移与 JSON 导入导出能力。
- [R5] 引入集中式状态容器（例如轻量自定义 store），统一管理 GM 存储、内存缓存与 Mutation 监听的同步。
- [R6] 对课程/作业/通知缓存定义明确 TTL 与失效策略，提供调试面板显示缓存状态及清理入口。

### 4.3 DOM、样式与交互
- [R7] 引入轻量模板层（如 lit-html / hyperscript / JSX with precompile）或组件工厂，避免大段 `innerHTML` 字符串与重复查询。
- [R8] 整理 CSS，按功能拆分并通过构建期合并，建立命名约定与主题变量，避免重复注入。
- [R9] 建立统一的 Observer/事件注册管理器，支持路由切换时自动回收，减少内存泄漏风险。

### 4.4 下载与资源处理
- [R10] 重新设计下载任务模型，支持队列、并发数限制、可取消、进度通知和错误重试，抽象出统一接口供单文件/批量下载复用。
- [R11] 提炼预览 URL 获取与鉴权逻辑，确保 GM/fetch 两种模式一致，并增加失败提示与人工重试选项。
- [R12] 对批量压缩生成 HTML 索引的过程进行流式处理，减少内存占用，并允许用户自定义文件命名策略。

### 4.5 性能与可用性
- [R13] 为高频 API（课程/通知/作业）增加请求去抖、差量更新及失败回退策略，避免重复请求。
- [x][R14] 优化 `Utils.wait` 等等待工具，支持明确的错误抛出、日志和诊断信息，同时提供同步模式减少 observer 数量。
- [R15] 为首页/课程页注入逻辑增加首屏优化，避免在 DOM 未准备好时大量操作导致卡顿。

### 4.6 稳定性、监控与回滚
- [R16] 引入统一的日志/埋点接口，可根据 DEBUG 设置切换等级，支持导出诊断信息。
- [R17] 为关键流程（拦截器、批量下载、作业面板）添加断言与异常捕获策略，出现异常时降级而非中断全部功能。
- [R18] 建立版本特性开关体系，允许通过 GM 菜单快速回滚新特性。

### 4.7 工程化与发布流程
- [R19] 建立 pnpm/yarn 项目，配置 ESLint（含 Tampermonkey/GM 插件）、Prettier、Commitlint，保持代码风格统一。
- [R20] 建立打包脚本（含元数据头自动生成、版本同步、资源 hash 更新）以及 changelog 自动化。
- [R21] 在 README/CONTRIBUTING 中补充本地开发、调试、发布流程说明。

### 4.8 测试与质量保障
- [R22] 为核心模块编写单元测试（可使用 Vitest/Jest + JSDOM），验证工具方法、状态管理、调度逻辑。
- [R23] 设计关键页面的集成测试脚本（可使用 Playwright/Selenium 连接仿真环境）验证 DOM 注入与交互流程。
- [R24] 引入自动化构建校验（GitHub Actions/CI），在合并前跑 lint、test 和打包检查。

## 5. 里程碑与交付物
- M1（进行中）：完成工程化脚手架与模块拆分雏形。**当前状态：已创建 TypeScript + Rollup 构建链路，并将原有脚本拆分为核心模块、工具库、服务层与入口脚本，构建产物位于 `dist/ucloud-evolved-plus.user.js`。后续需逐步移除 `@ts-nocheck` 并补齐类型。**
- M2：实现下载、课程、作业、通知等核心功能的重构与单元测试（~3 周）；交付重构后的脚本与测试报告。
- M3：完善 UI/主题、性能优化、监控埋点及 CI 流程（~2 周）；交付发布版脚本、Changelog 和回滚方案。

## 6. 风险与注意事项
- ucloud 官方页面结构随时可能调整，需要在重构前确认可获取的开发/测试环境，降低线上热修风险。
- 部分功能依赖 GM_* API（如 GM_download、GM_xmlhttpRequest），需确保在模块化后依然可用，并提供浏览器兼容矩阵。
- 确认批量下载/批量请求的速率限制，避免脚本触发平台风控；必要时增加节流与用户确认。
- 在进行大规模重构前保留现有分支与历史版本，确保回退路径清晰。
